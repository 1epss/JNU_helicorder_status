<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helicorder_one_station.HTML</title>
  <style>
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .controls button {
      margin-left: 8px;
    }
  </style>
</head>

<body>
  <h1 style="text-align:center;">충청·전라 내륙 연구용 지진관측소 Helicorder</h1>
  <h2>날짜·관측소별 Helicorder</h2>
  <hr>

  <div class="controls">
    <label for="startDate">시작</label>
    <input type="date" id="startDate" name="startDate">

    <label for="endDate">종료</label>
    <input type="date" id="endDate" name="endDate">

    <label for="station">관측소명</label>
    <input type="text" id="station" name="station" placeholder="예: JN01">

    <span>성분:</span>
    <label><input type="checkbox" id="compZ" name="comp" value="Z" checked> Z</label>
    <label><input type="checkbox" id="compN" name="comp" value="N" checked> N</label>
    <label><input type="checkbox" id="compE" name="comp" value="E" checked> E</label>

    <button type="button" id="searchBtn">검색</button>
  </div>

  <fieldset>
    <legend>Helicorder</legend>
    <div id="imageContainer" style="margin-top:12px;">
      <img id="resultImg" src=""
           style="display:none;width:90%;max-width:1100px;height:auto;margin:8px auto;
                  box-shadow:0 6px 18px rgba(0,0,0,0.18);">
      <p id="msg" style="color:#c00;text-align:center;margin:0;font-size:0.95rem"></p>
    </div>

    <script>
      (function () {
        const btn = document.getElementById('searchBtn');
        const dateInput = document.getElementById('startDate');
        const stationInput = document.getElementById('station');
        const msg = document.getElementById('msg');
        const resultImg = document.getElementById('resultImg');

        function checkImage(url) {
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = url;
          });
        }

        async function tryLoadImagesInRange(startStr, endStr) {
          if (!startStr) {
            msg.textContent = '시작 날짜를 선택하세요.';
            resultImg.src = '';
            return;
          }

          const station = stationInput ? stationInput.value.trim() : '';
          if (!station) {
            msg.textContent = '관측소명을 입력하세요.';
            resultImg.src = '';
            return;
          }

          const comps = Array.from(
            document.querySelectorAll('input[name="comp"]:checked')
          ).map(n => n.value);

          if (comps.length === 0) {
            msg.textContent = '성분(Z/N/E)을 하나 이상 선택하세요.';
            resultImg.src = '';
            return;
          }

          if (!endStr) endStr = startStr;
          let start = new Date(startStr);
          let end = new Date(endStr);
          if (start > end) { const t = start; start = end; end = t; }

          msg.textContent = '이미지 로드 중...';
          resultImg.src = '';

          const exts = ['.jpg', '.png'];
          const foundByDate = [];

          function formatYMD_local(d) {
            const Y = d.getFullYear();
            const M = String(d.getMonth() + 1).padStart(2, '0');
            const D = String(d.getDate()).padStart(2, '0');
            return `${Y}${M}${D}`;
          }

          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const ymd = formatYMD_local(d);
            const timestamp = ymd + '0000';
            const group = { ymd, images: [] };

            for (const comp of comps) {
              for (const ext of exts) {
                const candidate = `plots/helicorder_${station}_${timestamp}_${comp}${ext}`;
                const ok = await checkImage(candidate);
                if (ok) {
                  group.images.push(candidate);
                  break;
                }
              }
            }

            if (group.images.length > 0) foundByDate.push(group);
          }

          document.getElementById('thumbs')?.remove();

          if (foundByDate.length === 0) {
            msg.textContent = '해당 날짜의 자료가 없습니다.';
            resultImg.src = '';
            return;
          }

          msg.textContent = '';

          const thumbs = document.createElement('div');
          thumbs.id = 'thumbs';
          thumbs.style.textAlign = 'center';
          thumbs.style.marginTop = '8px';

          for (const grp of foundByDate) {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'center';
            row.style.alignItems = 'center';
            row.style.margin = '6px 0';

            const imgsWrap = document.createElement('div');
            imgsWrap.style.display = 'flex';
            imgsWrap.style.overflowX = 'auto';
            imgsWrap.style.justifyContent = 'center';
            imgsWrap.style.gap = '2px';

            const count = grp.images.length || 1;
            const pct = Math.floor(99 / count);

            for (const src of grp.images) {
              const im = document.createElement('img');
              im.src = src;
              im.alt = `Helicorder ${grp.ymd}`;
              im.style.flex = `0 0 ${pct}%`;
              im.style.maxWidth = `${pct}%`;
              im.style.height = 'auto';
              im.style.cursor = 'pointer';
              im.style.border = '1px solid #ddd';
              im.style.borderRadius = '4px';
              im.addEventListener('click', () => window.open(src, '_blank'));
              imgsWrap.appendChild(im);
            }

            row.appendChild(imgsWrap);
            thumbs.appendChild(row);
          }

          document.getElementById('imageContainer').appendChild(thumbs);
        }

        btn.addEventListener('click', function () {
          const startVal = dateInput.value;
          const endVal = document.getElementById('endDate')
            ? document.getElementById('endDate').value
            : '';
          tryLoadImagesInRange(startVal, endVal);
        });
      })();
    </script>
  </fieldset>

  <br>
</body>
</html>