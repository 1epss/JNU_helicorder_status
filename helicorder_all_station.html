<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helicorder_all_station.HTML</title>
  <style>
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .controls button {
      margin-left: 8px;
    }
  </style>
</head>

<body>
  <h1 style="text-align:center;">충청·전라 내륙 연구용 지진관측소 Helicorder</h1>
  <h2>날짜별 모든 관측소 Helicorder</h2>
  <hr>

  <div class="controls">
    <label for="selectDate">날짜</label>
    <input type="date" id="selectDate" name="selectDate">

    <span>성분:</span>
    <label><input type="checkbox" name="comp" value="Z" checked> Z</label>
    <label><input type="checkbox" name="comp" value="N" checked> N</label>
    <label><input type="checkbox" name="comp" value="E" checked> E</label>

    <button type="button" id="searchBtn">검색</button>
  </div>

  <fieldset>
    <legend>Helicorder</legend>
    <div id="imageContainer" style="margin-top:12px;">
      <p id="msg" style="color:#c00;text-align:center;margin:0;font-size:0.95rem"></p>
    </div>

    <script>
      (function () {
        const btn = document.getElementById('searchBtn');
        const dateInput = document.getElementById('selectDate');
        const msg = document.getElementById('msg');

        async function getStations() {
          try {
            const res = await fetch("stationlist.json?_t=" + Date.now());
            if (!res.ok) throw new Error();
            const data = await res.json();
            return data.stations || [];
          } catch {
            msg.textContent = "관측소 목록을 불러오는 중 오류가 발생했습니다.";
            return [];
          }
        }

        function checkImage(url) {
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = url;
          });
        }

        btn.addEventListener('click', async function () {
          const dateStr = dateInput.value;
          if (!dateStr) {
            msg.textContent = '날짜를 선택하세요.';
            return;
          }

          const comps = Array.from(document.querySelectorAll('input[name="comp"]:checked')).map(n => n.value);
          if (comps.length === 0) {
            msg.textContent = '성분(Z/N/E)을 하나 이상 선택하세요.';
            return;
          }

          msg.textContent = '관측소 목록 불러오는 중...';
          document.getElementById('thumbs')?.remove();

          const stations = await getStations();
          if (stations.length === 0) {
            msg.textContent = '관측소 목록이 없습니다.';
            return;
          }

          msg.textContent = '이미지 로드 중...';
          const exts = ['.jpg', '.png'];
          const ymd = dateStr.replaceAll('-', '');
          const timestamp = ymd + '0000';
          const foundImgs = [];

          for (const st of stations) {
            const images = [];
            for (const comp of comps) {
              for (const ext of exts) {
                const candidate = `plots/helicorder_${st}_${timestamp}_${comp}${ext}`;
                const ok = await checkImage(candidate);
                if (ok) {
                  images.push(candidate);
                  break;
                }
              }
            }
            if (images.length > 0) foundImgs.push({ station: st, images });
          }

          if (foundImgs.length === 0) {
            msg.textContent = '해당 날짜의 자료가 없습니다.';
            return;
          }

          msg.textContent = '';

          const thumbs = document.createElement('div');
          thumbs.id = 'thumbs';
          thumbs.style.margin = '0';
          thumbs.style.padding = '0';
          thumbs.style.width = '100%';

          const perRow = comps.length === 1 ? 3 : 1;

          for (let i = 0; i < foundImgs.length; i += perRow) {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'flex-start';
            row.style.margin = '0';
            row.style.padding = '0';
            row.style.width = '100%';
            row.style.gap = '2px';
            row.style.justifyContent = 'center';

            const rowSubset = foundImgs.slice(i, i + perRow);

            for (const grp of rowSubset) {
              const box = document.createElement('div');
              box.style.display = 'flex';
              box.style.flexDirection = 'column';
              box.style.alignItems = 'center';
              box.style.margin = '0';
              box.style.padding = '0';

              if (perRow === 3) {
                box.style.flex = '0 0 calc((100% - 4px) / 3)';
                box.style.maxWidth = 'calc((100% - 4px) / 3)';
              } else {
                box.style.flex = '1 1 100%';
                box.style.maxWidth = '100%';
              }

              const label = document.createElement('p');
              label.textContent = grp.station;
              label.style.margin = '2px 0';
              label.style.fontWeight = 'bold';
              label.style.fontSize = '0.9rem';
              label.style.width = '100%';
              label.style.textAlign = 'center';
              box.appendChild(label);

              const imgsWrap = document.createElement('div');
              imgsWrap.style.display = 'flex';
              imgsWrap.style.justifyContent = 'center';
              imgsWrap.style.width = '100%';
              imgsWrap.style.gap = '2px';

              const compCount = grp.images.length || 1;
              const pct = 100 / compCount;

              for (const src of grp.images) {
                const im = document.createElement('img');
                im.src = src;
                im.alt = `Helicorder ${grp.station}`;
                im.style.flex = `0 0 ${pct}%`;
                im.style.maxWidth = `${pct}%`;
                im.style.height = 'auto';
                im.style.cursor = 'pointer';
                im.style.border = '1px solid #ddd';
                im.addEventListener('click', () => window.open(src, '_blank'));
                imgsWrap.appendChild(im);
              }

              box.appendChild(imgsWrap);
              row.appendChild(box);
            }

            thumbs.appendChild(row);
          }

          document.getElementById('imageContainer').appendChild(thumbs);
        });
      })();
    </script>
  </fieldset>

  <br>
</body>
</html>